# PRM_4_113603_MLOps

Below is an illustration of the MLOps workflow in terms of the Generate+ETL (GETL) framework used in **Phys. Rev. Materials 4, 113603** (DOI: https://doi.org/10.1103/PhysRevMaterials.4.113603; or the [preprint](https://www.researchgate.net/publication/345634787_Chemical_bonding_in_metallic_glasses_from_machine_learning_and_crystal_orbital_Hamilton_population)):

![MLOPs workflow used in PRM_4_113603](img/PRM_4_113603_MLOps.drawio.png)

## üß™ 1. Problem Definition & Domain Context

- **Goal**: Predict chemical **bond strengths** (-ICOHP values) in metallic glasses at density functional theory (DFT)-level accuracy.

  - üìù **NOTE**: Within the context of Computational Chemistry, the "integrated COHP (the -ICOHP value) hints towards the **bond strength**"; COHP stands for ([Crystal Orbital Hamilton Populations](https://schmeling.ac.rwth-aachen.de/cohp/index.php?menuID=1)).

- **Challenge**: Direct DFT computation is computationally infeasible for large-scale (e.g. 10k-atom) systems, whose atomic level whole structure is more realistic.

## üß© 2. Data Generation & Labeling (DataOps phase)

- **Raw Data Sources**:

  - Classical Molecular Dynamics (CMD) simulations are used to to generate an ensemble of smaller systems (100-atom cells) whose atomic level local environments are representative of those found on large-scale systems.

  - Feasible first-principles electronic structure simulations based on DFT to compute -ICOHP values (**labels**) for the smaller systems.

- **Data Engineering**:

  - Convert atomic configurations (local environment around central atoms in terms of its neighbours; or simply **local atomic fingerprints**) to SOAP descriptors (**feature engineering**).
 
    - üìù **NOTE**: Within the context of Computational Chemistry/Materials Science, SOAP stands for ([Smooth Overlap of Atomic Positions](https://doi.org/10.1103/PhysRevB.87.184115)).

  - Database of interactions (DBIs) includes **bond distance**, **bond strengths**, and **local atomic fingerprints**.

    - üìù **NOTE**: In the end, what has been implemented was a **Feature Store Lite**, where each output DBI is the **structured** and **versioned input** to the ML model. 

- **Labeling Strategy**:

  - -ICOHP values calculated via DFT and COHP analysis are used as **supervised labels**.

## üõ†Ô∏è 3. Model Development (ModelOps phase)

- **Machine Learning (ML) Approach**: Gaussian Process Regression (GPR).

- **Feature Inputs**:

  - SOAP vectors for atoms in bonds (the SOAP descriptor itself is a feature vector; the ***dot product-based SOAP kernel*** measures similarity and can be used to derive a ***metric distance***).

  - Bond distances.

- **Custom Kernel Function**:

  - Designed to combine bond distance and SOAP similarity.

- **Output**: Predicted -ICOHP value (bond strength).

- **Evaluation**:

  - Root Mean Square Error (RMSE) on test data per **bond/interaction type**.
 
  - **Data augmentation** by applying geometric transformations (shear, tension, compression) to 100-atom cells generated by MD simulations to generate more structural diversity and improve ML generalization.

  - Satisfactory performance demonstrated with small training sets.

## üìê Architecture Diagram of the MLOps System

The architecture consists of a set of services (Streamlit, FastAPI, Airflow, and MLflow) which coordinate the execution of key components such as the data explorer and augmenter, the human-in-the-loop active learning process policy, and feature extraction pipeline.

![MLOPs system architecture](img/PRM_4_113603_MLOps_Architecture.drawio.png)

### üîç Key Services

- **Streamlit**: Presents model status, results, and enables expert input (e.g., approve/label samples, restart pipelines).
  - üîó [http://localhost:8501](http://localhost:8501)
  
- **FastAPI**: Controller layer that handles all user-triggered interactions (via Streamlit) and acts as the central gateway.
  - üîó [http://localhost:8000/docs](http://localhost:8000/docs)
  
- **Airflow**: Orchestrator that manages explore/exploit workflows, simulation preparation, and training DAGs (Directed Acyclic Graphs).
  - üîó [http://localhost:8080](http://localhost:8080)
  
- **MLflow**: The central model tracking hub for experiment tracking and model registry and lineage.
  - üîó [http://localhost:5000](http://localhost:5000)
  
- **PostgreSQL**: For structured data storage, supporting Airflow, the feature store (lite), and experiment metadata tracking.

### üîç Key Components

- **DAG Explore**: Start/restart HPC sampling (CMD or new compositions) ... Generate new 100-atom cells via CMD for a given NC (configurational diversity). ... used when the current data coverage isn‚Äôt enough; adds new independent structures. ... 

- **DAG Exploit/Augment**: Perform data augmentation (shear, tension, compression) on existing 100-atom cells. ... When the structural diversity of current configs needs improvement without running new CMD.

- **DAG ETL Model**: Feature Store	Lite: DB with versioned descriptors (SOAP + bond info) used for training/inference.

- **DAG Evaluate Model**: Evaluation Module ... RMSE per bond type, uncertainty scoring, active learning selection. ... Checks whether current model generalizes well. Decides if more Explore or Exploit is needed. ...
  - Cross-validation ... same DBI ...
  - Single-cell validation simulating production inference on one 100-atom cell. ... 

- **HPC Interface**: Bridge to job submission on non-cloud-native systems (e.g., LAMMPS, QE via SLURM).
  - ‚ö†Ô∏è ... It accurately mimics production pipelines while being cost-efficient for research/demo purposes. ... [third-party software used in atomistic simulations](https://github.com/aryrfjr/PRM_4_113603?tab=readme-ov-file#-third-party-software-used-in-atomistic-simulations)

- **Local/S3 Store**: Stores raw MD output, DFT results, SOAP descriptors, trained models.
  - ‚ö†Ô∏è  ... Scripts produce outputs identical in structure to standard simulation tools (e.g., LOBSTER, QE), ensuring consistency between ML-generated data and traditional quantum chemistry workflows. ... 

‚ö†Ô∏è **NOTE**: Explore vs Exploit is controlled by an active learning policy, e.g., based on prediction confidence or uncertainty.

| Decision Point                                                                                | Trigger                                             |
| --------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| **RMSE too high on current dataset, but data coverage seems OK (structurally)**               | ‚Üí Run more **augmentations** (`/augment`)           |
| **RMSE too high due to lack of configurational diversity** (not enough 100-atom cell samples) | ‚Üí Create more **100-atom cells** (`/generate/{nc}`) |
| **RMSE too high due to poor generalization across compositions**                              | ‚Üí Add **new NCs** (`/generate/{new_nc}`)            |
